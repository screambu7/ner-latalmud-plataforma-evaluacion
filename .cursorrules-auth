# ğŸ” Reglas de AutenticaciÃ³n - Ner LaTalmud

**Prioridad mÃ¡xima. Estas reglas prevalecen sobre cualquier otra si hay conflicto.**

â¸»

## ğŸ¯ Estado Oficial del Sistema de AutenticaciÃ³n

### âœ… MÃ‰TODO ACTIVO (ÃšNICO)
- **AutenticaciÃ³n por contraseÃ±a** (password-based)
- Hash con bcrypt
- SesiÃ³n mediante cookie httpOnly firmada

### âŒ MÃ‰TODOS CONGELADOS
- Magic Link
- Email-only login
- Invite-links sin password
- Auto-login por token

**Regla absoluta:**

Magic Link estÃ¡ congelado y NO debe usarse, ampliarse ni reactivarse.

â¸»

## ğŸš« PROHIBICIONES ABSOLUTAS (NO NEGOCIABLES)

### âŒ Magic Link
- No crear endpoints nuevos relacionados
- No modificar endpoints congelados
- No referenciar Magic Link en mensajes, logs o UI
- No crear usuarios sin passwordHash

### âŒ Usuarios sin contraseÃ±a
- **PROHIBIDO** crear usuarios sin passwordHash
- **PROHIBIDO** flows donde el usuario "despuÃ©s define su contraseÃ±a" sin autenticaciÃ³n
- **PROHIBIDO** signup que no incluya password

### âŒ Logging sensible
- **PROHIBIDO** loggear:
  - DATABASE_URL
  - tokens
  - cookies
  - hashes
  - secretos
- Logs deben ser estructurales, nunca secretos

### âŒ Endpoints inseguros
- **PROHIBIDO** cualquier endpoint de:
  - set-password
  - reset-password
  - invite
- Si NO tiene:
  - autenticaciÃ³n vÃ¡lida
  - autorizaciÃ³n explÃ­cita
  - validaciÃ³n de ownership o rol

â¸»

## âœ… REGLAS OBLIGATORIAS DE AUTH

### ğŸ”‘ Signup
- Siempre crea usuario con:
  - passwordHash (bcrypt)
  - estado = ACTIVO
- No genera links
- No envÃ­a correos
- No auto-login

### ğŸ” Login
- Solo password
- bcrypt.compare obligatorio
- Errores genÃ©ricos (no revelar si el correo existe)

### ğŸ”’ SesiÃ³n
- Cookie:
  - httpOnly
  - secure en prod
  - sameSite=lax
  - expiraciÃ³n clara
- Logout debe borrar cookie (maxAge=0)

â¸»

## ğŸ§± Middleware & ProtecciÃ³n
- Middleware NO accede a Prisma
- Middleware SOLO valida sesiÃ³n
- AutorizaciÃ³n fina:
  - En pÃ¡ginas
  - En server actions

â¸»

## ğŸ§  Mensajes de Error (UX segura)
- Nunca revelar:
  - si el usuario existe
  - si el password estÃ¡ mal
- Mensaje estÃ¡ndar:
  - "Correo o contraseÃ±a incorrectos"

â¸»

## ğŸ›‘ Cambios Prohibidos sin AprobaciÃ³n ExplÃ­cita

Cursor NO DEBE:
- Cambiar el flujo de auth
- Introducir nuevos mÃ©todos de login
- "Mejorar" seguridad inventando flows
- Reactivar Magic Link "temporalmente"

â¸»

## ğŸ” Flujo Permitido para Cambios de Auth
1. Documentar el cambio en `docs/00_OVERVIEW/GOVERNANCE.md`
2. Justificar riesgo
3. Aprobar explÃ­citamente (CTO/Owner)
4. Actualizar rules
5. Implementar
6. Auditar
7. Deploy

Si falta cualquiera, el cambio NO se hace.

â¸»

## ğŸ§ª Testing Obligatorio (Auth)

Toda modificaciÃ³n en auth requiere:
- Login correcto
- Login incorrecto
- Logout
- Hard reload
- Acceso bloqueado sin sesiÃ³n
- Acceso bloqueado por rol

â¸»

**Ãšltima actualizaciÃ³n:** hoy  
**Estado:** ACTIVO  
**Scope:** Backend, Auth, Security, Infra
