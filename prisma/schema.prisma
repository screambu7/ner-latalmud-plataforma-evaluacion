generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELOS PRINCIPALES
// ============================================

model Usuario {
  id            Int          @id @default(autoincrement())
  nombre        String
  correo        String       @unique
  passwordHash  String?      // Hash de contraseña (opcional para compatibilidad con usuarios existentes)
  celular       String?
  rol           Rol
  estado        EstadoCuenta
  escuelaId     Int?
  escuela       Escuela?     @relation(fields: [escuelaId], references: [id], onDelete: SetNull)
  creadoEn      DateTime     @default(now())
  actualizadoEn DateTime     @default(now()) @updatedAt

  // Relaciones
  evaluacionesCreadas Evaluacion[] @relation("Evaluador")
  reportesGenerados   Reporte[]    @relation("GeneradoPor")
  archivosSubidos     Archivo[]    @relation("SubidoPor")
}

model Escuela {
  id            Int          @id @default(autoincrement())
  nombre        String
  direccion     String?
  telefono      String?
  correo        String?
  estado        EstadoCuenta @default(ACTIVO)
  creadoEn      DateTime     @default(now())
  actualizadoEn DateTime     @default(now()) @updatedAt

  // Relaciones
  usuarios Usuario[]
  alumnos  Alumno[]
}

model Alumno {
  id            Int          @id @default(autoincrement())
  nombre        String
  correo        String?
  tipo          TipoAlumno
  escuelaId     Int?
  escuela       Escuela?     @relation(fields: [escuelaId], references: [id], onDelete: SetNull)
  status        StatusAlumno
  creadoEn      DateTime     @default(now())
  actualizadoEn DateTime     @default(now()) @updatedAt

  // Relaciones
  evaluaciones Evaluacion[]
  reportes     Reporte[]
}

model Evaluacion {
  id            Int             @id @default(autoincrement())
  alumnoId      Int
  alumno        Alumno          @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  evaluadorId   Int
  evaluador     Usuario         @relation("Evaluador", fields: [evaluadorId], references: [id], onDelete: Restrict)
  tipo          TipoDiagnostico
  fecha         DateTime        @default(now())
  creadoEn      DateTime        @default(now())
  actualizadoEn DateTime        @default(now()) @updatedAt

  // Relaciones
  detalles EvaluacionDetalle[]
  reportes Reporte[]
}

model EvaluacionDetalle {
  id           Int        @id @default(autoincrement())
  evaluacionId Int
  evaluacion   Evaluacion @relation(fields: [evaluacionId], references: [id], onDelete: Cascade)
  subhabilidad String
  nivel        Int
  creadoEn     DateTime   @default(now())
}

model Reporte {
  id            Int         @id @default(autoincrement())
  tipo          TipoReporte
  evaluacionId  Int?
  evaluacion    Evaluacion? @relation(fields: [evaluacionId], references: [id], onDelete: SetNull)
  alumnoId      Int?
  alumno        Alumno?     @relation(fields: [alumnoId], references: [id], onDelete: SetNull)
  generadoPorId Int
  generadoPor   Usuario     @relation("GeneradoPor", fields: [generadoPorId], references: [id], onDelete: Restrict)
  contenido     Json? // Datos estructurados del reporte
  fechaInicio   DateTime?
  fechaFin      DateTime?
  creadoEn      DateTime    @default(now())
  actualizadoEn DateTime    @default(now()) @updatedAt

  // Relaciones
  archivos Archivo[]
}

model Archivo {
  id             Int         @id @default(autoincrement())
  nombre         String
  nombreOriginal String
  tipo           TipoArchivo
  mimeType       String
  tamaño        Int // en bytes
  ruta           String // ruta de almacenamiento
  reporteId      Int?
  reporte        Reporte?    @relation(fields: [reporteId], references: [id], onDelete: Cascade)
  subidoPorId    Int
  subidoPor      Usuario     @relation("SubidoPor", fields: [subidoPorId], references: [id], onDelete: Restrict)
  creadoEn       DateTime    @default(now())
  actualizadoEn  DateTime    @default(now()) @updatedAt
}

model LoginToken {
  id           Int       @id @default(autoincrement())
  email        String
  tokenHash    String    @unique
  expiresAt    DateTime
  usedAt       DateTime?
  createdAt    DateTime  @default(now())
  ip           String?
  userAgent    String?
  @@index([email])
  @@index([expiresAt])
}

enum Rol {
  SUPER_ADMIN
  EVALUADOR
}

enum EstadoCuenta {
  ACTIVO
  INACTIVO
}

enum TipoAlumno {
  ESCUELA
  INDEPENDIENTE
}

enum StatusAlumno {
  ACTIVO
  EN_PAUSA
  NO_ACTIVO
  NIVEL_LOGRADO
}

enum TipoDiagnostico {
  GV_EXP_DEF_FACIL
  GV_EXP_FACIL
  GV_HA_FACIL_NK
  GV_HA_FACIL_SN
  GN_EXP_DEF_FACIL
  GN_EXP_FACIL
  GN_HA_FACIL_NK
  GN_HA_FACIL_SN
  GV_EXP_DEF_DIFICIL
  GV_EXP_DIFICIL
  GV_HA_DIFICIL_NK
  GV_HA_DIFICIL_SN
  GN_EXP_DEF_DIFICIL
  GN_EXP_DIFICIL
  GN_HA_DIFICIL_NK
  GN_HA_DIFICIL_SN
}

enum TipoReporte {
  EVALUACION_INDIVIDUAL
  EVALUACION_GRUPAL
  PROGRESO_ALUMNO
  ESTADISTICAS_ESCUELA
  REPORTE_GENERAL
}

enum TipoArchivo {
  PDF_REPORTE
  PDF_EVALUACION
  EXCEL_DATOS
  IMAGEN
  DOCUMENTO
  OTRO
}
